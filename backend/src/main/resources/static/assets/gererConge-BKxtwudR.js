import{a as f}from"./config-CkEC2-gR.js";import"./authGuard-IHeZeQgb.js";function m(o,s="info"){const r={success:"bg-green-500",error:"bg-red-500",info:"bg-blue-500"},c=document.createElement("div");c.className=`${r[s]} text-white px-4 py-2 rounded-lg shadow-lg fixed top-4 right-4 z-50 animate-bounce`,c.textContent=o,document.body.appendChild(c),setTimeout(()=>{c.remove()},4e3)}const E=document.getElementById("pcStartDate"),v=document.getElementById("pcEndDate"),I=document.getElementById("pcNumDays"),k=document.getElementById("pcAddCongeBtn");let b="";function x(o){b=o}function A(){if(!E||!v||!I)return;const o=new Date(E.value),s=new Date(v.value);if(o.toString()!=="Invalid Date"&&s.toString()!=="Invalid Date"&&s>=o){const r=s-o,c=Math.floor(r/(1e3*60*60*24))+1;I.textContent=c}else I.textContent=0}E&&v&&(E.addEventListener("change",A),v.addEventListener("change",A));async function U(o){try{const s=`${f}/suivi-conge/jours-restants?reference=${encodeURIComponent(o)}`,r=await fetch(s),c=await r.json();if(!r.ok)throw new Error(c.message||"Impossible de récupérer les jours restants");const a=document.getElementById("pcJoursRestants");a&&(a.textContent=c.joursRestants??"--")}catch(s){console.error("Erreur fetch jours restants:",s);const r=document.getElementById("pcJoursRestants");r&&(r.textContent="--")}}k&&k.addEventListener("click",async()=>{const o=document.getElementById("pcMatricule"),s=document.getElementById("pcJoursRestants");if(!o||!s){m("Éléments manquants dans le DOM","error");return}const r=o.textContent.trim(),c=E.value,a=v.value,d=parseInt(I.textContent,10),i=parseInt(s.textContent,10);if(!b){m("Référence de congé invalide.","info");return}if(!r||r==="--"){m("Matricule agent introuvable.","error");return}if(!c||!a){m("Veuillez choisir la période.","error");return}if(!d||d<=0){m("Nombre de jours invalide.","error");return}if(d>i){m(`Vous demandez ${d} jours alors qu'il ne reste que ${i} jours.`,"error");return}const w={matricule:r,congeRef:b,dateDebut:c,dateFin:a,jours:d};try{const y=await fetch(`${f}/suivi-conge`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)}),l=await y.json();if(!y.ok){const p=l.message||"Erreur lors de l'ajout du congé";throw new Error(`${p}`)}m(`Congé ajouté avec succès (ID: ${l.id})`,"success"),E.value="",v.value="",I.textContent="0",await U(b)}catch(y){m("error.message"+y.message,"error")}});document.addEventListener("DOMContentLoaded",()=>{if(!window.AuthGuard){console.error("AuthGuard non disponible"),window.location.replace("./login.html");return}function o(e,t="info"){const u={success:"bg-green-500",error:"bg-red-500",info:"bg-blue-500"},n=document.createElement("div");n.className=`${u[t]} text-white px-4 py-2 rounded-lg shadow-lg fixed top-4 right-4 z-50 animate-bounce`,n.textContent=e,document.body.appendChild(n),setTimeout(()=>{n.remove()},4e3)}const s=document.getElementById("refNumber"),r=document.getElementById("year"),c=document.getElementById("checkBtn"),a=document.getElementById("result"),d=document.getElementById("retourBtn"),i=document.getElementById("popupCongeOverlay"),w=document.getElementById("popupCloseBtn"),y=document.getElementById("popupDecisionNumber"),l=document.getElementById("popupNom"),p=document.getElementById("popupPrenom"),g=document.getElementById("popupMatricule"),j=document.getElementById("popupJoursConges"),P=document.getElementById("popupConfirmerBtn"),S=document.getElementById("popupAnnulerBtn"),J=document.getElementById("manageLeaves"),H=document.getElementById("priseCongeSection");let L="",R="",C="";function O(){i.classList.remove("hidden"),i.classList.add("flex"),C=`${L}/DRH/${R}`,y.value=C}function B(){i.classList.add("hidden"),i.classList.remove("flex")}function $(){g.value="",j.value="0",l.value="",p.value=""}function D(){document.querySelectorAll("#dashboard, #addAgent, #priseCongeSection").forEach(e=>e.classList.add("hidden")),J.classList.remove("hidden"),s.value="",r.value="2025",a.innerHTML="",d.classList.add("hidden")}function T(e){document.querySelectorAll("#dashboard, #manageLeaves, #addAgent").forEach(t=>t.classList.add("hidden")),H.classList.remove("hidden"),z(e)}async function M(e){if(!e.trim()){l.value="",p.value="";return}try{const t=await fetch(`${f}/agent/nomPrenom?matricule=${encodeURIComponent(e)}`);if(t.ok){const u=await t.json();l.value=u.nom||"",p.value=u.prenom||""}else l.value="",p.value=""}catch(t){l.value="",p.value="",console.error(t)}}async function z(e){try{const t=await fetch(`${f}/agent/byConge?ref=${encodeURIComponent(e)}`);if(!t.ok)throw new Error("Agent non trouvé");const u=await t.json(),n=u.agent,h=u.jours??0,q=(await(await fetch(`${f}/suivi-conge/jours-restants?reference=${encodeURIComponent(e)}`)).json()).joursRestants??0;document.getElementById("pcRefConge").textContent=e,document.getElementById("pcMatricule").textContent=n.matricule??"-",document.getElementById("pcNom").textContent=n.nom??"-",document.getElementById("pcPrenom").textContent=n.prenom??"-",document.getElementById("pcFonction").textContent=n.fonction??"-",document.getElementById("pcJoursAttribues").textContent=h,document.getElementById("pcJoursRestants").textContent=q,typeof x=="function"&&x(e)}catch(t){console.error("Erreur récupération infos congé:",t),document.getElementById("pcRefConge").textContent=e,document.getElementById("pcMatricule").textContent="-",document.getElementById("pcNom").textContent="-",document.getElementById("pcPrenom").textContent="-",document.getElementById("pcFonction").textContent="-",document.getElementById("pcJoursAttribues").textContent="0",document.getElementById("pcJoursRestants").textContent="0",typeof x=="function"&&x(e)}}c.addEventListener("click",async()=>{const e=s.value.trim(),t=r.value.trim();if(!e||!t){a.innerHTML=`<span class="text-red-600">Veuillez entrer le numéro et l'année.</span>`;return}L=e,R=t;const u=`${e}/DRH/${t}`;try{const n=await fetch(`${f}/conge/checkRef?refNumber=${e}&year=${t}`),h=await n.text();n.ok?(a.innerHTML=`<span class="text-green-600">Référence trouvée : <b>${u}</b></span>`,setTimeout(()=>T(u),500)):(a.innerHTML=`<span class="text-red-600">${h}</span>`,setTimeout(O,300))}catch(n){a.innerHTML=`<span class="text-red-600">Erreur: ${n.message}</span>`}}),d.addEventListener("click",D),document.getElementById("retourPriseCongeBtn").addEventListener("click",D),w.addEventListener("click",B),i.addEventListener("click",e=>{e.target===i&&B()}),S.addEventListener("click",()=>{$(),B()}),P.addEventListener("click",async()=>{const e=g.value.trim(),t=parseInt(j.value)||0;if(!e)return o("Veuillez saisir un matricule.","info");if(t<=0)return o("Nombre de jours invalide.","info");const u={reference:C,matriculeAgent:e,jours:t};try{const n=await fetch(`${f}/conge`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)}),h=await n.json();if(n.ok)B(),$(),a.innerHTML='<span class="text-green-600">Congé créé avec succès !</span>',setTimeout(()=>T(C),500);else{const N=h.message||"Erreur lors de la création du congé";o(`${N}`,"error")}}catch(n){o(`Erreur de connexion : ${n.message}`,"error")}}),g.addEventListener("input",e=>{clearTimeout(g.searchTimeout),g.searchTimeout=setTimeout(()=>{M(e.target.value.trim())},500)}),g.addEventListener("blur",()=>M(g.value.trim()))});
